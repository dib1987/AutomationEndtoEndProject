# Copilot Instructions for AutomationEndtoEndProject

AI coding agent guidance for this Selenium + TestNG + Page Object Model automation framework.

## Architecture Overview
**Stack:** Java 11, Maven, Selenium 4.23.1, TestNG 7.7.0  
**Core patterns:** Page Object Model (POM), Factory pattern for driver/options, ThreadLocal for thread-safe WebDriver management, listener-based reporting.

### Layer Structure
- **Factory layer** (`com.qa.opencart.factory/`): `DriverFactory` (WebDriver initialization with ThreadLocal), `OptionsManager` (browser capabilities)
- **Page layer** (`com.qa.opencart.pages/`): Page classes encapsulate locators & page interactions (e.g., `LoginPage`, `AccountsPage`)
- **Utility layer** (`com.qa.opencart.utils/`): `ElementUtil` (waits, clicks, text extraction), `JavaScriptUtil` (JS execution), `ExcelUtil` (data-driven testing)
- **Test layer** (`com.qa.opencart.tests/`): Test classes extend `BaseTest`, use page objects to interact with UI
- **Support** (`com.qa.opencart.listeners/`): `ExtentReportListener` (HTML reports), `TestAllureListener` (Allure attachments), `AnnotationTransformer` (retry logic)

## Execution & Configuration

### Running Tests Locally
```bash
# Standard regression suite
mvn clean test -Dsurefire.suiteXmlFiles=src/test/resources/testrunners/testng_Regression.xml -Denv=qa

# Specific suite with environment
mvn clean test -Dsurefire.suiteXmlFiles=src/test/resources/testrunners/testng_sanity.xml -Denv=stage

# Parallel execution (controlled via testng_*.xml thread-count & parallel attributes)
```

### Configuration Files
- Environment configs: `src/test/resources/config/{qa|dev|stage|uat|prod}.config.properties`
- **Key properties:** `browser` (chrome/firefox/edge/safari), `url`, `remote` (true/false), `huburl` (Selenium Grid), `headless`, `incognito`, `highlight`, `username`, `pwd`
- **Example:** `qa.config.properties` sets `remote=true` and Selenoid URL; override with `-Denv=dev` for local execution

### TestNG Suite Structure
- Parallel tests with `thread-count="4" parallel="tests"` in suite XML (e.g., `testng_Regression.xml`)
- Browser parameter per test: `<parameter name="browser" value="chrome"/>` (overrides config file)
- Listeners registered in suite: `ExtentReportListener`, `AnnotationTransformer`, `TestAllureListener`

## Critical Patterns & Usage

### BaseTest Lifecycle
```java
@BeforeTest: Initialize Properties → DriverFactory → Page objects (LoginPage, etc.)
@AfterTest: driver.quit() (ThreadLocal cleanup handled by framework)
```

### ElementUtil as Action Hub
Prefer `ElementUtil` methods over raw WebDriver calls:
- **Waits:** `waitForElementVisible(By, timeout)`, `waitForTitleContainsAndReturn(...)`, `waitForURLContainsAndReturn(...)`
- **Actions:** `doClick(By)`, `doSendKeys(By, String)`, `doGetElementText(By)`
- **Checks:** `isElementDisplayed(By)`, `doElementGetAttribute(By, name)`
- Element highlighting: If `highlight=true` in config, `ElementUtil.getElement()` flashes the element via `JavaScriptUtil`

### Page Object Model Example (LoginPage)
```java
// 1. Locators as private By fields
private By username = By.id("input-email");

// 2. Constructor injects driver
public LoginPage(WebDriver driver) { ... }

// 3. Public methods return actions or other page objects
public AccountsPage doLogin(String userName, String pwd) {
  eleUtil.doSendKeys(username, userName);
  eleUtil.doClick(loginBtn);
  return new AccountsPage(driver); // Fluent-like chaining
}
```

### Adding New Tests
1. Create test class in `src/test/java/com/qa/opencart/tests/`, extend `BaseTest`
2. Instantiate/reuse page objects from `BaseTest` (already initialized in `@BeforeTest`)
3. Use `ElementUtil` for all interactions; assertions via `SoftAssert` (declared in `BaseTest`)
4. Register test in a TestNG suite XML: add `<class name="com.qa.opencart.tests.YourTest"/>`
5. Set browser: add `<parameter name="browser" value="chrome"/>` above test class (or use config file default)

### Adding New Page Objects
1. Create class in `src/main/java/com/qa/opencart/pages/`
2. Private By locators for all UI elements
3. Constructor: `public YourPage(WebDriver driver)` + `eleUtil = new ElementUtil(driver)`
4. Public methods for user interactions; return `this` for chaining or next page object (e.g., `return new NextPage(driver)`)

## Reporting & CI Integration

### Extent Reports
- HTML output: `./reports/TestExecutionReport.html`
- Generated by `ExtentReportListener` (implements `ITestListener`)
- Automatic screenshot capture on failure (via `DriverFactory1.takeScreenshot()` — note: currently uses `DriverFactory1` instead of `DriverFactory`)

### Allure Reports
- Listener: `TestAllureListener` attaches step descriptions & failure screenshots
- Jenkins publishes results; local: view in Allure report viewer

### Jenkinsfile
- Regression stage: `mvn clean test -Dsurefire.suiteXmlFiles=src/test/resources/testrunners/testng_Regression.xml -Denv=qa`
- Publishes Allure & HTML artifacts
- Note: Jenkinsfile git URLs are placeholders; real repo: `https://github.com/dib1987/AutomationEndtoEndProject.git`

## Important Implementation Details

### ThreadLocal WebDriver Isolation
- `DriverFactory.tlDriver` is `ThreadLocal<WebDriver>` — each test thread gets isolated driver
- Parallel execution via Maven Surefire fork count + TestNG `thread-count` & `parallel` attributes
- **Critical:** Never store driver in static field; always use `tlDriver.get()` or `DriverFactory.getDriver()`

### Remote WebDriver (Selenium Grid / Selenoid)
- Set `remote=true` in config file
- Update `huburl` to point to grid/container: `huburl=http://18.209.67.144:4444/wd/hub` (or localhost for local grid)
- `OptionsManager` constructs RemoteWebDriver with capabilities when `remote=true`

### Browser Options via OptionsManager
- **Chrome:** headless, incognito support (boolean config properties)
- **Firefox, Edge, Safari:** similar options available
- Properties control behavior: `headless=true` + `incognito=true` for private headless execution

## Common Gotchas & Fixes

| Issue | Fix |
|-------|-----|
| `qa.config.properties` has `huburl:http://...` (colon instead of =) | Change to `huburl=http://...` |
| Tests fail on remote grid — driver not initializing | Verify `remote=true` and `huburl` points to running grid |
| Screenshot attachment fails | `ExtentReportListener` uses `DriverFactory1.takeScreenshot()`; consider consolidating to `DriverFactory` |
| Tests pass locally but fail in Jenkins | Check `-Denv` parameter matches environment config; verify Selenoid/grid URL in Jenkins agents |
| Test flakiness with waits | Use `ElementUtil` wait methods with appropriate timeout; avoid `Thread.sleep()` |

## Quick Reference

| What | Where |
|------|-------|
| Run tests | `mvn clean test -Dsurefire.suiteXmlFiles=src/test/resources/testrunners/testng_Regression.xml -Denv=qa` |
| Add test | `src/test/java/com/qa/opencart/tests/YourTest.java` (extend BaseTest) |
| Add page | `src/main/java/com/qa/opencart/pages/YourPage.java` (POM pattern) |
| Configs | `src/test/resources/config/*.config.properties` |
| Waits/actions | `ElementUtil` methods (`doClick`, `doSendKeys`, `waitForElementVisible`, etc.) |
| Reports | `./reports/TestExecutionReport.html` (Extent) |
| Suite XML | `src/test/resources/testrunners/testng_Regression.xml` (thread-count, parallel, listeners) |
